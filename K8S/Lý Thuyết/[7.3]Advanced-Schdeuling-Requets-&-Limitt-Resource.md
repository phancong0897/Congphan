# XÃ¡c Ä‘á»‹nh cÃ¡c giÃ¡ trá»‹ Requests vÃ  Limits resources cho containers

Khi Kubernetes lÃªn lá»‹ch cho Pod ( tá»©c lÃ  ra quyáº¿t Ä‘á»‹nh deploy pods vá»›i tÃ i nguyÃªn nhÆ° tháº¿ nÃ o vÃ  deploy trÃªn node nÃ o náº¿u lÃ  cá»¥m kubernetes cluster), thÃ¬ Ä‘iá»u quan trá»ng lÃ  cÃ¡c container cÃ³ Ä‘á»§ tÃ i nguyÃªn Ä‘á»ƒ hoáº¡t Ä‘á»™ng hiá»‡u quáº£. Náº¿u báº¡n lÃªn lá»‹ch cho má»™t á»©ng dá»¥ng lá»›n trÃªn má»™t node cÃ³ tÃ i nguyÃªn háº¡n cháº¿, thÃ¬ node Ä‘Ã³ cÃ³ thá»ƒ háº¿t bá»™ nhá»› hoáº·c tÃ i nguyÃªn CPU vÃ  má»i thá»© ngá»«ng hoáº¡t Ä‘á»™ng! Ngay cáº£ trong quÃ¡ trÃ¬nh váº­n hÃ nh, cÃ³ ráº¥t nhiá»u nguyÃªn nhÃ¢n nhÆ° cáº¥u hÃ¬nh khÃ´ng tá»‘t, do lá»—i code,.. cÃ³ thá»ƒ dáº«n Ä‘áº¿n viá»‡c á»©ng dá»¥ng cá»§a báº¡n sá»­ dá»¥ng tÃ i nguyÃªn hÆ¡n má»©c cáº§n thiáº¿t. VÃ  dÃ¹ lá»—i xáº£y ra vÃ¬ nguyÃªn nhÃ¢n gÃ¬, chÃºng ta cÅ©ng cáº§n tÃ¬m ra cÃ¡c giáº£i phÃ¡p Ä‘á»ƒ kiá»ƒm soÃ¡t chÃºng má»™t cÃ¡ch tá»‘t nháº¥t cÃ³ thá»ƒ. Má»™t trong nhá»¯ng giáº£i phÃ¡p Ä‘á»ƒ báº¡n cÃ³ thá»ƒ giáº£i quyáº¿t nhá»¯ng váº¥n Ä‘á» lÃ  báº±ng cÃ¡ch chá»‰ Ä‘á»‹nh cÃ¡c Request (yÃªu cáº§u) vÃ  Limit (giá»›i háº¡n) tÃ i nguyÃªn.

### Request vÃ  Limit resource lÃ  gÃ¬ vÃ  hoáº¡t Ä‘á»™ng nhÆ° tháº¿ nÃ o?

- Requests: Báº£o Ä‘áº£m vá» lÆ°á»£ng tÃ i nguyÃªn mÃ  má»™t pod trong workload sáº½ Ä‘Æ°á»£c cáº¥p. Máº·c Ä‘á»‹nh cÃ¡c thuá»™c tÃ­nh nÃ y sáº½ Ä‘á»ƒ trá»‘ng hoáº·c láº¥y theo yÃªu cáº§u máº·c Ä‘á»‹nh cá»§a namespace (sáº½ Ä‘Æ°á»£c Ä‘á» cáº­p sau). TÃ i nguyÃªn request tá»‘i Ä‘a pháº£i nhá» hÆ¡n lÆ°á»£ng tÃ i nguyÃªn mÃ  má»™t server máº¡nh nháº¥t trong cluster cÃ³ thá»ƒ táº£i Ä‘Æ°á»£c.
    
    - VÃ­ dá»¥: request: 100mCPU, 256MiB RAM mang Ã½ nghÄ©a báº¡n sáº½ luÃ´n Ä‘áº£m báº£o ráº±ng k8s sáº½ cáº¥p cho báº¡n Ã­t nháº¥t 100 mCPU vÃ  256MiB RAM. Há»‡ thá»‘ng sáº½ chá»‰ deploy pod cá»§a báº¡n trÃªn node cÃ³ Ä‘á»§ sá»‘ lÆ°á»£ng tÃ i nguyÃªn nhÆ° trÃªn. Táº¥t nhiÃªn kube-scheduler cÃ³ Ä‘Ã¡nh dáº¥u lÆ°á»£ng tÃ i nguyÃªn nÃ y Ä‘Ã£ bá»‹ chiáº¿m dá»¥ng.
    
    - Giáº£ sá»­ báº¡n cÃ³ 2 node, node 1 cÃ³ 2 vCore vÃ  8GiB RAM, node 2 cÃ³ 4 vCore 16GiB RAM, náº¿u workload cá»§a báº¡n yÃªu cáº§u request: 2500mCPU, 8GiB RAM thÃ¬ server sáº½ chá»‰ deploy pod cá»§a workload nÃ y vÃ o node 2.
    
    - Trong trÆ°á»ng há»£p cÅ©ng vá»›i cáº¥u hÃ¬nh trÃªn mÃ  báº¡n yÃªu cáº§u tÃ i nguyÃªn request: 4000mCPU, 8GiB RAM, sáº½ khÃ´ng cÃ³ pod nÃ o Ä‘Æ°á»£c deploy cáº£.

    - Pods sáº½ nháº­n Ä‘Æ°á»£c sá»‘ lÆ°á»£ng bá»™ nhá»› mÃ  nÃ³ yÃªu cáº§u. Náº¿u vÆ°á»£t quÃ¡ yÃªu cáº§u bá»™ nhá»›, bá»™ nhá»› cÃ³ thá»ƒ bá»‹ kill (loáº¡i bá») náº¿u má»™t Pod khÃ¡c náº£y sinh nhu cáº§u vá»›i bá»™ nhá»› nÃ y. Pods chá»‰ bá»‹ loáº¡i bá» khi sá»­ dá»¥ng Ã­t bá»™ nhá»› hÆ¡n yÃªu cáº§u náº¿u há»‡ thá»‘ng quan trá»ng hoáº·c workload Æ°u tiÃªn cáº§n bá»™ nhá»›.

    - TÆ°Æ¡ng tá»±, container trong Pod Ä‘Æ°á»£c phÃ¢n bá»• sá»‘ lÆ°á»£ng CPU mÃ  nÃ³ yÃªu cáº§u, náº¿u cÃ³ sáºµn. CPU cÅ©ng cÃ³ thá»ƒ Ä‘Æ°á»£c phÃ¢n bá»• cÃ¡c chu ká»³ CPU bá»• sung náº¿u cÃ¡c Pods hoáº·c cÃ´ng viá»‡c khÃ¡c khÃ´ng cáº§n tá»›i tÃ i nguyÃªn cÃ³ sáºµn nÃ y.

    - LÆ°u Ã½: náº¿u tá»•ng sá»‘ yÃªu cáº§u Pod khÃ´ng cÃ³ sáºµn trÃªn má»™t node , thÃ¬ Pod sáº½ váº«n á»Ÿ tráº¡ng thÃ¡i â€œPending stateâ€ (Äang chá» xá»­ lÃ½, tá»©c lÃ  khÃ´ng cháº¡y) cho Ä‘áº¿n khi cÃ¡c tÃ i nguyÃªn nÃ y kháº£ dá»¥ng.

- Limits: Giá»›i háº¡n lÆ°á»£ng tÃ i nguyÃªn mÃ  má»™t pod trong workload sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng
    
    - VÃ­ dá»¥: limits: 1000mCPU, 2GiB RAM mang Ã½ nghÄ©a ráº±ng báº¡n chá»‰ cÃ³ thá»ƒ dÃ¹ng tá»‘i Ä‘a 1 CPU vÃ  2GiB RAM.

    - Giá»›i háº¡n tÃ i nguyÃªn giÃºp bá»™ láº­p lá»‹ch Kubernetes xá»­ lÃ½ tá»‘t hÆ¡n sá»± tranh cháº¥p tÃ i nguyÃªn. Khi má»™t Pod sá»­ dá»¥ng nhiá»u bá»™ nhá»› hÆ¡n giá»›i háº¡n cá»§a nÃ³, cÃ¡c tiáº¿n trÃ¬nh cá»§a nÃ³ sáº½ bá»‹ kernel loáº¡i bá» (kill) Ä‘á»ƒ báº£o vá»‡ cÃ¡c á»©ng dá»¥ng khÃ¡c trong cluster. Pods sáº½ Ä‘Æ°á»£c Ä‘iá»u chá»‰nh CPU khi vÆ°á»£t quÃ¡ giá»›i háº¡n CPU cá»§a chÃºng.
    
    - Náº¿u khÃ´ng cÃ³ giá»›i háº¡n nÃ o Ä‘Æ°á»£c Ä‘áº·t, thÃ¬ cÃ¡c pods cÃ³ thá»ƒ sá»­ dá»¥ng bá»™ nhá»› vÃ  CPU dÆ° thá»«a khi kháº£ dá»¥ng.
    
    - Náº¿u báº¡n chá»‰ Ä‘á»‹nh giá»›i háº¡n CPU cho container nhÆ°ng khÃ´ng chá»‰ Ä‘á»‹nh yÃªu cáº§u CPU, Kubernetes sáº½ tá»± Ä‘á»™ng chá»‰ Ä‘á»‹nh yÃªu cáº§u CPU phÃ¹ há»£p vá»›i giá»›i háº¡n. TÆ°Æ¡ng tá»±, náº¿u má»™t container chá»‰ Ä‘á»‹nh giá»›i háº¡n bá»™ nhá»› cá»§a riÃªng nÃ³, nhÆ°ng khÃ´ng chá»‰ Ä‘á»‹nh yÃªu cáº§u bá»™ nhá»›, Kubernetes sáº½ tá»± Ä‘á»™ng gÃ¡n má»™t yÃªu cáº§u bá»™ nhá»› phÃ¹ há»£p vá»›i giá»›i háº¡n.
    
    - LÆ°u Ã½: Äiá»u quan trá»ng cáº§n nhá»› lÃ  Limits khÃ´ng bao giá» Ä‘Æ°á»£c tháº¥p hÆ¡n Request. Báº¡n cÃ³ thá»ƒ thá»­ Ä‘áº·t cÃ¡c giÃ¡ trá»‹ nhÆ° váº­y, Kubernetes sáº½ bÃ¡o lá»—i vÃ  khÃ´ng cho phÃ©p báº¡n cháº¡y container cá»§a mÃ¬nh Ä‘Ã¢u ğŸ˜„

- Má»™t Pod lÃ  má»™t khÃ¡i niá»‡m trá»«u tÆ°á»£ng cá»§a Kubernetes, Ä‘áº¡i diá»‡n cho má»™t nhÃ³m gá»“m má»™t hoáº·c nhiá»u á»©ng dá»¥ng containers (vÃ­ dá»¥ nhÆ° Docker hoáº·c rkt) vÃ  má»™t sá»‘ tÃ i nguyÃªn Ä‘Æ°á»£c chia sáº» cho cÃ¡c containers Ä‘Ã³. Äáº¿n lÆ°á»£t mÃ¬nh, cÃ¡c pod cÃ³ thá»ƒ Ä‘Æ°á»£c triá»ƒn khai vÃ  quáº£n lÃ½ trÃªn cÃ¡c node. Má»—i node trong má»™t cá»¥m Kubernetes cÃ³ má»™t lÆ°á»£ng bá»™ nhá»› (RAM) vÃ  CPU Ä‘Æ°á»£c phÃ¢n bá»• cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ cháº¡y cÃ¡c pods.

- CÃ¡c yÃªu cáº§u vÃ  giá»›i háº¡n tÃ i nguyÃªn lÃ  cÃ¡c tham sá»‘ tÃ¹y chá»n Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh á»Ÿ cáº¥p Ä‘á»™ cá»§a container. Kubernetes tÃ­nh toÃ¡n má»™t yÃªu cáº§u vÃ  giá»›i háº¡n cá»§a Pod báº±ng giÃ¡ trá»‹ tá»•ng há»£p yÃªu cáº§u vÃ  giá»›i háº¡n trÃªn táº¥t cáº£ cÃ¡c container cá»§a nÃ³. Kubernetes sau Ä‘Ã³ sáº½ sá»­ dá»¥ng cÃ¡c tham sá»‘ nÃ y Ä‘á»ƒ lÃªn lá»‹ch vÃ  quyáº¿t Ä‘á»‹nh phÃ¢n bá»• tÃ i nguyÃªn cho pods.

### CÆ¡ cháº¿ deploy vÃ  kill cá»§a kube-scheduler

- Náº¿u báº¡n táº¡o má»™t cluster k8s tá»« cÃ¡c cÃ´ng cá»¥ nhÆ° k3s, kubeadm hay tá»« cÃ¡c bÃªn cung cáº¥p ná»n táº£ng nhÆ° AKS (cá»§a Azure), EKS (cá»§a Amazon) thÃ¬ máº·c Ä‘á»‹nh cluster Ä‘Ã³ sáº½ sá»­ dá»¥ng kube-scheduler Ä‘á»ƒ kiá»ƒm soÃ¡t viá»‡c quáº£n lÃ½ tÃ i nguyÃªn vÃ  deploy pod. Viá»‡c deploy hay kill pod cá»§a kube-scheduler Ä‘á»u hoáº¡t Ä‘á»™ng theo hai bÆ°á»›c: Lá»c vÃ  Cháº¥m Ä‘iá»ƒm.

- TrÆ°á»ng há»£p k8s deploy má»™t pod vÃ o cluster:

    - BÆ°á»›c Lá»c: kube-scheduler sáº½ liá»‡t kÃª táº¥t cáº£ cÃ¡c node thá»a mÃ£n Ä‘iá»u kiá»‡n tá»‘i thiá»ƒu cá»§a workload (tá»©c thá»a mÃ£n lÆ°á»£ng tÃ i nguyÃªn request). Náº¿u trong danh sÃ¡ch Ä‘Ã³ khÃ´ng cÃ³ node nÃ o, pod cá»§a báº¡n sáº½ khÃ´ng bao giá» Ä‘Æ°á»£c deploy. CÃ¡c pod chÆ°a Ä‘Æ°á»£c deploy váº«n sáº½ cÃ³ cÆ¡ há»™i Ä‘Æ°á»£c cháº¡y do kube-scheduler sáº½ thá»±c hiá»‡n viá»‡c cháº¥m Ä‘iá»ƒm nÃ y liÃªn tá»¥c.
    
    - BÆ°á»›c Cháº¥m Ä‘iá»ƒm: kube-scheduler sáº½ Ä‘Ã¡nh giÃ¡ cÃ¡c node thÃ´ng qua nhiá»u tiÃªu chÃ­ khÃ¡c nhau, tá»« Ä‘Ã³ Ä‘Æ°a ra Ä‘iá»ƒm sá»‘ cá»§a node Ä‘Ã³. kube-scheduler sáº½ deploy vÃ o node cÃ³ Ä‘iá»ƒm sá»‘ cao nháº¥t. Náº¿u cÃ³ nhiá»u hÆ¡n 1 node cÃ³ cÃ¹ng má»™t Ä‘iá»ƒm sá»‘, pod sáº½ Ä‘Æ°á»£c deploy ngáº«u nhiÃªn vÃ o má»™t trong cÃ¡c node Ä‘Ã³.

- CÃ²n trÆ°á»ng há»£p k8s cáº§n kill pod Ä‘á»ƒ thu há»“i láº¡i tÃ i nguyÃªn:

    - BÆ°á»›c Lá»c: kube-scheduler sáº½ liá»‡t kÃª táº¥t cáº£ cÃ¡c pod Ä‘ang hoáº¡t Ä‘á»™ng trong node Ä‘ang bá»‹ quÃ¡ táº£i.
    
    - BÆ°á»›c Cháº¥m Ä‘iá»ƒm: kube-scheduler sáº½ Ä‘Ã¡nh giÃ¡ cÃ¡c pod Ä‘Ã³ thÃ´ng qua Ä‘á»™ Æ°u tiÃªn cá»§a pod (Pod Priority). Pod nÃ o cÃ³ Ä‘iá»ƒm Æ°u tiÃªn tháº¥p hÆ¡n sáº½ bá»‹ kill, cÃ¡c pod cÃ³ Ä‘iá»ƒm Æ°u tiÃªn ngang nhau sáº½ Ä‘Æ°á»£c kill ngáº«u nhiÃªn. Viá»‡c nÃ y sáº½ láº·p Ä‘i láº·p láº¡i Ä‘áº¿n khi server Ä‘á»§ tÃ i nguyÃªn thÃ¬ thÃ´i. NhÆ°ng thÃ´ng thÆ°á»ng chÃºng ta thÆ°á»ng bá» quÃªn máº¥t tÃ­nh nÄƒng nÃ y, nÃªn cÃ¡c pod sáº½ cÃ³ Ä‘iá»ƒm Æ°u tiÃªn ngang nhau, vÃ¬ váº­y cÃ¡c pod sáº½ bá»‹ cháº¥m Ä‘iá»ƒm thÃ´ng qua lÆ°á»£ng tÃ i nguyÃªn sá»­ dá»¥ng. CÃ¡c pod vÆ°á»£t quÃ¡ tÃ i nguyÃªn yÃªu cáº§u cÃ ng nhiá»u, thÃ¬ pod Ä‘Ã³ cÃ ng cÃ³ kháº£ nÄƒng bá»‹ kill. Viá»‡c nÃ y cÅ©ng sáº½ láº·p Ä‘i láº·p láº¡i Ä‘áº¿n khi server Ä‘á»§ tÃ i nguyÃªn thÃ¬ thÃ´i.
    
    - Trong trÆ°á»ng há»£p báº¡n cÃ³ Ä‘áº·t má»©c Ä‘á»™ Æ°u tiÃªn cho pod, náº¿u báº¡n Ä‘áº·t cho pod cá»§a mÃ¬nh cÃ³ Ä‘á»™ Æ°u tiÃªn cao hÆ¡n cÃ¡c pod há»‡ thá»‘ng nhÆ° kubelet, k8s cÃ³ thá»ƒ kill luÃ´n cÃ¡c pod Ä‘Ã³ Ä‘á»ƒ thu há»“i bá»™ nhá»›. Táº¥t nhiÃªn viá»‡c nÃ y vá»«a cÃ³ lá»£i Ä‘iá»ƒm vÃ  háº¡i Ä‘iá»ƒm.
    
        - Äiá»ƒm tá»‘t: Node cá»§a báº¡n váº«n sáº½ cháº¡y vÃ  má»i thá»© sáº½ Ä‘Æ°á»£c deploy trá»Ÿ láº¡i khi pod cá»§a báº¡n tráº£ láº¡i tÃ i nguyÃªn cho há»‡ thá»‘ng.
    
        - Äiá»ƒm khÃ´ng tá»‘t: Khiáº¿n báº¡n lo láº¯ng khi node Ä‘Æ°á»£c thÃ´ng bÃ¡o lÃ  Ä‘Ã£ crash vÃ  khÃ´ng cÃ³ thÃ´ng tin nÃ o Ä‘Æ°á»£c cáº­p nháº­t vá». Tá»‡ hÆ¡n ná»¯a, node fail quÃ¡ lÃ¢u sáº½ khiáº¿n cho há»‡ thá»‘ng bÃªn thá»© ba tÆ°á»Ÿng node cá»§a báº¡n Ä‘Ã£ sáº­p (node tained), node sáº½ bá»‹ xoÃ¡ Ä‘i vÃ  thay tháº¿ báº±ng node má»›i, máº¥t toÃ n bá»™ nhá»¯ng gÃ¬ mÃ  node cá»§a báº¡n Ä‘ang thá»±c hiá»‡n (vÃ­ dá»¥ nhÆ° GKE autoscaler sáº½ thay node Ä‘ang sáº­p báº±ng node má»›i sau má»™t khoáº£ng thá»i gian).

Viá»‡c Lá»c vÃ  Cháº¥m Ä‘iá»ƒm sáº½ Ä‘Æ°á»£c Ä‘á»‹nh Ä‘oáº¡t báº±ng má»™t trong hai quy cÃ¡ch: ThÃ´ng qua cÃ¡c quy cháº¿ Ä‘Ã£ quy Ä‘á»‹nh (Policies) hoáº·c thÃ´ng qua cÃ¡c profile quy cháº¿ (Profiles) nhÆ°ng trong pháº¡m vi bÃ i viáº¿t nÃ y, chÃºng ta sáº½ khÃ´ng Ä‘á» cáº­p kÄ© Ä‘áº¿n hai quy cÃ¡ch phá»©c táº¡p trÃªn mÃ  sáº½ xoÃ¡y vÃ o cÆ¡ cháº¿ tÃ i nguyÃªn CPU vÃ  RAM.